---
import { useTranslations } from '../i18n/utils';
import type { Lang } from '../i18n/ui';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const t = useTranslations(lang);

const rows = [
  'cost',
  'custody',
  'lightning',
  'maintenance',
  'permissions',
  'setup',
  'business',
  'opensource',
  'kyc',
  'platform',
] as const;

const competitors = ['square', 'wosblink', 'btcpay', 'zeus', 'ambrosia'] as const;

const statuses = ['yes', 'no', 'warn', 'fast', 'slow'];

function parseCell(value: string): { status?: string; main: string; sub?: string } {
  const parts = value.split('|');

  if (parts.length === 1) {
    return { main: parts[0] };
  }

  if (statuses.includes(parts[0])) {
    // status|main or status|main|subtitle
    return { status: parts[0], main: parts[1], sub: parts[2] || undefined };
  }

  // main|subtitle (no status)
  return { main: parts[0], sub: parts[1] };
}

function getStatusIcon(status: string) {
  switch (status) {
    case 'yes':
      return { icon: '‚úì', class: 'text-green-400' };
    case 'no':
      return { icon: '‚úó', class: 'text-red-400' };
    case 'warn':
      return { icon: '‚ö†', class: 'text-yellow-400' };
    case 'fast':
      return { icon: '‚ö°', class: 'text-green-400' };
    case 'slow':
      return { icon: 'üêå', class: 'text-red-400' };
    default:
      return null;
  }
}
---

<section id="why-ambrosia" class="py-20 md:py-28 px-4 md:px-8 bg-surface-section">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-12 md:mb-16">
      <h2 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold text-th mb-4 px-2">
        {t('why.header')}
      </h2>
      <p class="text-base md:text-lg lg:text-xl text-tsec max-w-3xl mx-auto px-2">
        {t('why.subheader')}
      </p>
    </div>

    <!-- Comparison Table -->
    <div class="relative">
      <!-- Scroll hint for mobile/tablet -->
      <div class="lg:hidden text-center text-tm text-sm mb-3 flex items-center justify-center gap-2">
        <svg class="w-4 h-4 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
        </svg>
        <span>Scroll to compare</span>
      </div>

      <div class="overflow-x-auto pb-4">
        <table class="w-full min-w-237.5 border-collapse">
          <thead>
            <tr>
              <th class="sticky left-0 z-10 bg-surface-overlay backdrop-blur-md p-4 text-left text-sm font-semibold text-tb border-b border-b-default min-w-35">
                {t('why.table.feature')}
              </th>
              {competitors.map((comp) => (
                <th class:list={[
                  "p-4 text-center text-sm font-semibold border-b min-w-40",
                  comp === 'ambrosia'
                    ? "bg-green-400/10 text-green-400 border-green-400/30"
                    : "bg-table-header text-tb border-b-default"
                ]}>
                  <div class="font-bold">{t(`why.table.${comp}` as any)}</div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {rows.map((row, idx) => (
              <tr class={idx % 2 === 0 ? 'bg-table-row-even' : 'bg-table-row-odd'}>
                <td class="sticky left-0 z-10 p-4 text-sm font-medium text-ts border-b border-b-subtle bg-surface-overlay backdrop-blur-md">
                  {t(`why.row.${row}` as any)}
                </td>
                {competitors.map((comp) => {
                  const cellValue = t(`why.row.${row}.${comp}` as any);
                  const parsed = parseCell(cellValue);
                  const statusInfo = parsed.status ? getStatusIcon(parsed.status) : null;
                  const isAmbrosia = comp === 'ambrosia';

                  return (
                    <td class:list={[
                      "p-4 text-center text-sm border-b border-b-subtle",
                      isAmbrosia ? "bg-green-400/5" : ""
                    ]}>
                      <div class:list={[
                        "flex flex-col items-center gap-1",
                        isAmbrosia ? "font-semibold text-green-400" : "text-tb"
                      ]}>
                        {statusInfo && (
                          <span class={`text-lg ${statusInfo.class}`}>
                            {statusInfo.icon}
                          </span>
                        )}
                        <span class={isAmbrosia ? "text-green-400" : ""}>{parsed.main}</span>
                        {parsed.sub && (
                          <span class="text-xs text-tm">{parsed.sub}</span>
                        )}
                      </div>
                    </td>
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <!-- Gradient fade on right edge (mobile/tablet) -->
      <div class="absolute top-0 right-0 bottom-0 w-8 bg-linear-to-l from-gradient-fade to-transparent pointer-events-none lg:hidden"></div>
    </div>
  </div>
</section>
